{"ast":null,"code":"var Text,\n    Tool,\n    createShape,\n    getIsPointInBox,\n    extend = function (child, parent) {\n  for (var key in parent) {\n    if (hasProp.call(parent, key)) child[key] = parent[key];\n  }\n\n  function ctor() {\n    this.constructor = child;\n  }\n\n  ctor.prototype = parent.prototype;\n  child.prototype = new ctor();\n  child.__super__ = parent.prototype;\n  return child;\n},\n    hasProp = {}.hasOwnProperty;\n\nTool = require('./base').Tool;\ncreateShape = require('../core/shapes').createShape;\n\ngetIsPointInBox = function (point, box) {\n  if (point.x < box.x) {\n    return false;\n  }\n\n  if (point.y < box.y) {\n    return false;\n  }\n\n  if (point.x > box.x + box.width) {\n    return false;\n  }\n\n  if (point.y > box.y + box.height) {\n    return false;\n  }\n\n  return true;\n};\n\nmodule.exports = Text = function (superClass) {\n  extend(Text, superClass);\n  Text.prototype.name = 'Text';\n  Text.prototype.iconName = 'text';\n\n  function Text() {\n    this.text = '';\n    this.font = 'bold 18px sans-serif';\n    this.currentShape = null;\n    this.currentShapeState = null;\n    this.initialShapeBoundingRect = null;\n    this.dragAction = null;\n    this.didDrag = false;\n  }\n\n  Text.prototype.didBecomeActive = function (lc) {\n    var switchAway, unsubscribeFuncs, updateInputEl;\n    unsubscribeFuncs = [];\n\n    this.unsubscribe = function (_this) {\n      return function () {\n        var func, i, len, results;\n        results = [];\n\n        for (i = 0, len = unsubscribeFuncs.length; i < len; i++) {\n          func = unsubscribeFuncs[i];\n          results.push(func());\n        }\n\n        return results;\n      };\n    }(this);\n\n    switchAway = function (_this) {\n      return function () {\n        _this._ensureNotEditing(lc);\n\n        _this._clearCurrentShape(lc);\n\n        return lc.repaintLayer('main');\n      };\n    }(this);\n\n    updateInputEl = function (_this) {\n      return function () {\n        return _this._updateInputEl(lc);\n      };\n    }(this);\n\n    unsubscribeFuncs.push(lc.on('drawingChange', switchAway));\n    unsubscribeFuncs.push(lc.on('zoom', updateInputEl));\n    unsubscribeFuncs.push(lc.on('imageSizeChange', updateInputEl));\n    unsubscribeFuncs.push(lc.on('snapshotLoad', function (_this) {\n      return function () {\n        _this._clearCurrentShape(lc);\n\n        return lc.repaintLayer('main');\n      };\n    }(this)));\n    unsubscribeFuncs.push(lc.on('primaryColorChange', function (_this) {\n      return function (newColor) {\n        if (!_this.currentShape) {\n          return;\n        }\n\n        _this.currentShape.color = newColor;\n\n        _this._updateInputEl(lc);\n\n        return lc.repaintLayer('main');\n      };\n    }(this)));\n    return unsubscribeFuncs.push(lc.on('setFont', function (_this) {\n      return function (font) {\n        if (!_this.currentShape) {\n          return;\n        }\n\n        _this.font = font;\n\n        _this.currentShape.setFont(font);\n\n        _this._setShapesInProgress(lc);\n\n        _this._updateInputEl(lc);\n\n        return lc.repaintLayer('main');\n      };\n    }(this)));\n  };\n\n  Text.prototype.willBecomeInactive = function (lc) {\n    if (this.currentShape) {\n      this._ensureNotEditing(lc);\n\n      this.commit(lc);\n    }\n\n    return this.unsubscribe();\n  };\n\n  Text.prototype.setText = function (text) {\n    return this.text = text;\n  };\n\n  Text.prototype._ensureNotEditing = function (lc) {\n    if (this.currentShapeState === 'editing') {\n      return this._exitEditingState(lc);\n    }\n  };\n\n  Text.prototype._clearCurrentShape = function (lc) {\n    this.currentShape = null;\n    this.initialShapeBoundingRect = null;\n    this.currentShapeState = null;\n    return lc.setShapesInProgress([]);\n  };\n\n  Text.prototype.commit = function (lc) {\n    if (this.currentShape.text) {\n      lc.saveShape(this.currentShape);\n    }\n\n    this._clearCurrentShape(lc);\n\n    return lc.repaintLayer('main');\n  };\n\n  Text.prototype._getSelectionShape = function (ctx, backgroundColor) {\n    if (backgroundColor == null) {\n      backgroundColor = null;\n    }\n\n    return createShape('SelectionBox', {\n      shape: this.currentShape,\n      ctx: ctx,\n      backgroundColor: backgroundColor\n    });\n  };\n\n  Text.prototype._setShapesInProgress = function (lc) {\n    switch (this.currentShapeState) {\n      case 'selected':\n        return lc.setShapesInProgress([this._getSelectionShape(lc.ctx), this.currentShape]);\n\n      case 'editing':\n        return lc.setShapesInProgress([this._getSelectionShape(lc.ctx, '#fff')]);\n\n      default:\n        return lc.setShapesInProgress([this.currentShape]);\n    }\n  };\n\n  Text.prototype.begin = function (x, y, lc) {\n    var br, point, selectionBox, selectionShape;\n    this.dragAction = 'none';\n    this.didDrag = false;\n\n    if (this.currentShapeState === 'selected' || this.currentShapeState === 'editing') {\n      br = this.currentShape.getBoundingRect(lc.ctx);\n      selectionShape = this._getSelectionShape(lc.ctx);\n      selectionBox = selectionShape.getBoundingRect();\n      point = {\n        x: x,\n        y: y\n      };\n\n      if (getIsPointInBox(point, br)) {\n        this.dragAction = 'move';\n      }\n\n      if (getIsPointInBox(point, selectionShape.getBottomRightHandleRect())) {\n        this.dragAction = 'resizeBottomRight';\n      }\n\n      if (getIsPointInBox(point, selectionShape.getTopLeftHandleRect())) {\n        this.dragAction = 'resizeTopLeft';\n      }\n\n      if (getIsPointInBox(point, selectionShape.getBottomLeftHandleRect())) {\n        this.dragAction = 'resizeBottomLeft';\n      }\n\n      if (getIsPointInBox(point, selectionShape.getTopRightHandleRect())) {\n        this.dragAction = 'resizeTopRight';\n      }\n\n      if (this.dragAction === 'none' && this.currentShapeState === 'editing') {\n        this.dragAction = 'stop-editing';\n\n        this._exitEditingState(lc);\n      }\n    } else {\n      this.color = lc.getColor('primary');\n      this.currentShape = createShape('Text', {\n        x: x,\n        y: y,\n        text: this.text,\n        color: this.color,\n        font: this.font,\n        v: 1\n      });\n      this.dragAction = 'place';\n      this.currentShapeState = 'selected';\n    }\n\n    if (this.dragAction === 'none') {\n      this.commit(lc);\n      return;\n    }\n\n    this.initialShapeBoundingRect = this.currentShape.getBoundingRect(lc.ctx);\n    this.dragOffset = {\n      x: x - this.initialShapeBoundingRect.x,\n      y: y - this.initialShapeBoundingRect.y\n    };\n\n    this._setShapesInProgress(lc);\n\n    return lc.repaintLayer('main');\n  };\n\n  Text.prototype[\"continue\"] = function (x, y, lc) {\n    var br, brBottom, brRight;\n\n    if (this.dragAction === 'none') {\n      return;\n    }\n\n    br = this.initialShapeBoundingRect;\n    brRight = br.x + br.width;\n    brBottom = br.y + br.height;\n\n    switch (this.dragAction) {\n      case 'place':\n        this.currentShape.x = x;\n        this.currentShape.y = y;\n        this.didDrag = true;\n        break;\n\n      case 'move':\n        this.currentShape.x = x - this.dragOffset.x;\n        this.currentShape.y = y - this.dragOffset.y;\n        this.didDrag = true;\n        break;\n\n      case 'resizeBottomRight':\n        this.currentShape.setSize(x - (this.dragOffset.x - this.initialShapeBoundingRect.width) - br.x, y - (this.dragOffset.y - this.initialShapeBoundingRect.height) - br.y);\n        break;\n\n      case 'resizeTopLeft':\n        this.currentShape.setSize(brRight - x + this.dragOffset.x, brBottom - y + this.dragOffset.y);\n        this.currentShape.setPosition(x - this.dragOffset.x, y - this.dragOffset.y);\n        break;\n\n      case 'resizeBottomLeft':\n        this.currentShape.setSize(brRight - x + this.dragOffset.x, y - (this.dragOffset.y - this.initialShapeBoundingRect.height) - br.y);\n        this.currentShape.setPosition(x - this.dragOffset.x, this.currentShape.y);\n        break;\n\n      case 'resizeTopRight':\n        this.currentShape.setSize(x - (this.dragOffset.x - this.initialShapeBoundingRect.width) - br.x, brBottom - y + this.dragOffset.y);\n        this.currentShape.setPosition(this.currentShape.x, y - this.dragOffset.y);\n    }\n\n    this._setShapesInProgress(lc);\n\n    lc.repaintLayer('main');\n    return this._updateInputEl(lc);\n  };\n\n  Text.prototype.end = function (x, y, lc) {\n    if (!this.currentShape) {\n      return;\n    }\n\n    this.currentShape.setSize(this.currentShape.forcedWidth, 0);\n\n    if (this.currentShapeState === 'selected') {\n      if (this.dragAction === 'place' || this.dragAction === 'move' && !this.didDrag) {\n        this._enterEditingState(lc);\n      }\n    }\n\n    this._setShapesInProgress(lc);\n\n    lc.repaintLayer('main');\n    return this._updateInputEl(lc);\n  };\n\n  Text.prototype._enterEditingState = function (lc) {\n    var onChange;\n    this.currentShapeState = 'editing';\n\n    if (this.inputEl) {\n      throw \"State error\";\n    }\n\n    this.inputEl = document.createElement('textarea');\n    this.inputEl.className = 'text-tool-input';\n    this.inputEl.style.position = 'absolute';\n    this.inputEl.style.transformOrigin = '0px 0px';\n    this.inputEl.style.backgroundColor = 'transparent';\n    this.inputEl.style.border = 'none';\n    this.inputEl.style.outline = 'none';\n    this.inputEl.style.margin = '0';\n    this.inputEl.style.padding = '4px';\n    this.inputEl.style.zIndex = '1000';\n    this.inputEl.style.overflow = 'hidden';\n    this.inputEl.style.resize = 'none';\n    this.inputEl.value = this.currentShape.text;\n    this.inputEl.addEventListener('mousedown', function (e) {\n      return e.stopPropagation();\n    });\n    this.inputEl.addEventListener('touchstart', function (e) {\n      return e.stopPropagation();\n    });\n\n    onChange = function (_this) {\n      return function (e) {\n        _this.currentShape.setText(e.target.value);\n\n        _this.currentShape.enforceMaxBoundingRect(lc);\n\n        _this._setShapesInProgress(lc);\n\n        lc.repaintLayer('main');\n\n        _this._updateInputEl(lc);\n\n        return e.stopPropagation();\n      };\n    }(this);\n\n    this.inputEl.addEventListener('keydown', function (_this) {\n      return function () {\n        return _this._updateInputEl(lc, true);\n      };\n    }(this));\n    this.inputEl.addEventListener('keyup', onChange);\n    this.inputEl.addEventListener('change', onChange);\n\n    this._updateInputEl(lc);\n\n    lc.containerEl.appendChild(this.inputEl);\n    this.inputEl.focus();\n    return this._setShapesInProgress(lc);\n  };\n\n  Text.prototype._exitEditingState = function (lc) {\n    this.currentShapeState = 'selected';\n    lc.containerEl.removeChild(this.inputEl);\n    this.inputEl = null;\n\n    this._setShapesInProgress(lc);\n\n    return lc.repaintLayer('main');\n  };\n\n  Text.prototype._updateInputEl = function (lc, withMargin) {\n    var br, transformString;\n\n    if (withMargin == null) {\n      withMargin = false;\n    }\n\n    if (!this.inputEl) {\n      return;\n    }\n\n    br = this.currentShape.getBoundingRect(lc.ctx, true);\n    this.inputEl.style.font = this.currentShape.font;\n    this.inputEl.style.color = this.currentShape.color;\n    this.inputEl.style.left = lc.position.x / lc.backingScale + br.x * lc.scale - 4 + \"px\";\n    this.inputEl.style.top = lc.position.y / lc.backingScale + br.y * lc.scale - 4 + \"px\";\n\n    if (withMargin && !this.currentShape.forcedWidth) {\n      this.inputEl.style.width = br.width + 10 + this.currentShape.renderer.emDashWidth + \"px\";\n    } else {\n      this.inputEl.style.width = br.width + 12 + \"px\";\n    }\n\n    if (withMargin) {\n      this.inputEl.style.height = br.height + 10 + this.currentShape.renderer.metrics.leading + \"px\";\n    } else {\n      this.inputEl.style.height = br.height + 10 + \"px\";\n    }\n\n    transformString = \"scale(\" + lc.scale + \")\";\n    this.inputEl.style.transform = transformString;\n    this.inputEl.style.webkitTransform = transformString;\n    this.inputEl.style.MozTransform = transformString;\n    this.inputEl.style.msTransform = transformString;\n    return this.inputEl.style.OTransform = transformString;\n  };\n\n  Text.prototype.optionsStyle = 'font';\n  return Text;\n}(Tool);","map":{"version":3,"sources":["C:/Users/lukeq/blog/node_modules/literallycanvas/lib/js/tools/Text.js"],"names":["Text","Tool","createShape","getIsPointInBox","extend","child","parent","key","hasProp","call","ctor","constructor","prototype","__super__","hasOwnProperty","require","point","box","x","y","width","height","module","exports","superClass","name","iconName","text","font","currentShape","currentShapeState","initialShapeBoundingRect","dragAction","didDrag","didBecomeActive","lc","switchAway","unsubscribeFuncs","updateInputEl","unsubscribe","_this","func","i","len","results","length","push","_ensureNotEditing","_clearCurrentShape","repaintLayer","_updateInputEl","on","newColor","color","setFont","_setShapesInProgress","willBecomeInactive","commit","setText","_exitEditingState","setShapesInProgress","saveShape","_getSelectionShape","ctx","backgroundColor","shape","begin","br","selectionBox","selectionShape","getBoundingRect","getBottomRightHandleRect","getTopLeftHandleRect","getBottomLeftHandleRect","getTopRightHandleRect","getColor","v","dragOffset","brBottom","brRight","setSize","setPosition","end","forcedWidth","_enterEditingState","onChange","inputEl","document","createElement","className","style","position","transformOrigin","border","outline","margin","padding","zIndex","overflow","resize","value","addEventListener","e","stopPropagation","target","enforceMaxBoundingRect","containerEl","appendChild","focus","removeChild","withMargin","transformString","left","backingScale","scale","top","renderer","emDashWidth","metrics","leading","transform","webkitTransform","MozTransform","msTransform","OTransform","optionsStyle"],"mappings":"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","sourcesContent":["var Text, Tool, createShape, getIsPointInBox,\n  extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },\n  hasProp = {}.hasOwnProperty;\n\nTool = require('./base').Tool;\n\ncreateShape = require('../core/shapes').createShape;\n\ngetIsPointInBox = function(point, box) {\n  if (point.x < box.x) {\n    return false;\n  }\n  if (point.y < box.y) {\n    return false;\n  }\n  if (point.x > box.x + box.width) {\n    return false;\n  }\n  if (point.y > box.y + box.height) {\n    return false;\n  }\n  return true;\n};\n\nmodule.exports = Text = (function(superClass) {\n  extend(Text, superClass);\n\n  Text.prototype.name = 'Text';\n\n  Text.prototype.iconName = 'text';\n\n  function Text() {\n    this.text = '';\n    this.font = 'bold 18px sans-serif';\n    this.currentShape = null;\n    this.currentShapeState = null;\n    this.initialShapeBoundingRect = null;\n    this.dragAction = null;\n    this.didDrag = false;\n  }\n\n  Text.prototype.didBecomeActive = function(lc) {\n    var switchAway, unsubscribeFuncs, updateInputEl;\n    unsubscribeFuncs = [];\n    this.unsubscribe = (function(_this) {\n      return function() {\n        var func, i, len, results;\n        results = [];\n        for (i = 0, len = unsubscribeFuncs.length; i < len; i++) {\n          func = unsubscribeFuncs[i];\n          results.push(func());\n        }\n        return results;\n      };\n    })(this);\n    switchAway = (function(_this) {\n      return function() {\n        _this._ensureNotEditing(lc);\n        _this._clearCurrentShape(lc);\n        return lc.repaintLayer('main');\n      };\n    })(this);\n    updateInputEl = (function(_this) {\n      return function() {\n        return _this._updateInputEl(lc);\n      };\n    })(this);\n    unsubscribeFuncs.push(lc.on('drawingChange', switchAway));\n    unsubscribeFuncs.push(lc.on('zoom', updateInputEl));\n    unsubscribeFuncs.push(lc.on('imageSizeChange', updateInputEl));\n    unsubscribeFuncs.push(lc.on('snapshotLoad', (function(_this) {\n      return function() {\n        _this._clearCurrentShape(lc);\n        return lc.repaintLayer('main');\n      };\n    })(this)));\n    unsubscribeFuncs.push(lc.on('primaryColorChange', (function(_this) {\n      return function(newColor) {\n        if (!_this.currentShape) {\n          return;\n        }\n        _this.currentShape.color = newColor;\n        _this._updateInputEl(lc);\n        return lc.repaintLayer('main');\n      };\n    })(this)));\n    return unsubscribeFuncs.push(lc.on('setFont', (function(_this) {\n      return function(font) {\n        if (!_this.currentShape) {\n          return;\n        }\n        _this.font = font;\n        _this.currentShape.setFont(font);\n        _this._setShapesInProgress(lc);\n        _this._updateInputEl(lc);\n        return lc.repaintLayer('main');\n      };\n    })(this)));\n  };\n\n  Text.prototype.willBecomeInactive = function(lc) {\n    if (this.currentShape) {\n      this._ensureNotEditing(lc);\n      this.commit(lc);\n    }\n    return this.unsubscribe();\n  };\n\n  Text.prototype.setText = function(text) {\n    return this.text = text;\n  };\n\n  Text.prototype._ensureNotEditing = function(lc) {\n    if (this.currentShapeState === 'editing') {\n      return this._exitEditingState(lc);\n    }\n  };\n\n  Text.prototype._clearCurrentShape = function(lc) {\n    this.currentShape = null;\n    this.initialShapeBoundingRect = null;\n    this.currentShapeState = null;\n    return lc.setShapesInProgress([]);\n  };\n\n  Text.prototype.commit = function(lc) {\n    if (this.currentShape.text) {\n      lc.saveShape(this.currentShape);\n    }\n    this._clearCurrentShape(lc);\n    return lc.repaintLayer('main');\n  };\n\n  Text.prototype._getSelectionShape = function(ctx, backgroundColor) {\n    if (backgroundColor == null) {\n      backgroundColor = null;\n    }\n    return createShape('SelectionBox', {\n      shape: this.currentShape,\n      ctx: ctx,\n      backgroundColor: backgroundColor\n    });\n  };\n\n  Text.prototype._setShapesInProgress = function(lc) {\n    switch (this.currentShapeState) {\n      case 'selected':\n        return lc.setShapesInProgress([this._getSelectionShape(lc.ctx), this.currentShape]);\n      case 'editing':\n        return lc.setShapesInProgress([this._getSelectionShape(lc.ctx, '#fff')]);\n      default:\n        return lc.setShapesInProgress([this.currentShape]);\n    }\n  };\n\n  Text.prototype.begin = function(x, y, lc) {\n    var br, point, selectionBox, selectionShape;\n    this.dragAction = 'none';\n    this.didDrag = false;\n    if (this.currentShapeState === 'selected' || this.currentShapeState === 'editing') {\n      br = this.currentShape.getBoundingRect(lc.ctx);\n      selectionShape = this._getSelectionShape(lc.ctx);\n      selectionBox = selectionShape.getBoundingRect();\n      point = {\n        x: x,\n        y: y\n      };\n      if (getIsPointInBox(point, br)) {\n        this.dragAction = 'move';\n      }\n      if (getIsPointInBox(point, selectionShape.getBottomRightHandleRect())) {\n        this.dragAction = 'resizeBottomRight';\n      }\n      if (getIsPointInBox(point, selectionShape.getTopLeftHandleRect())) {\n        this.dragAction = 'resizeTopLeft';\n      }\n      if (getIsPointInBox(point, selectionShape.getBottomLeftHandleRect())) {\n        this.dragAction = 'resizeBottomLeft';\n      }\n      if (getIsPointInBox(point, selectionShape.getTopRightHandleRect())) {\n        this.dragAction = 'resizeTopRight';\n      }\n      if (this.dragAction === 'none' && this.currentShapeState === 'editing') {\n        this.dragAction = 'stop-editing';\n        this._exitEditingState(lc);\n      }\n    } else {\n      this.color = lc.getColor('primary');\n      this.currentShape = createShape('Text', {\n        x: x,\n        y: y,\n        text: this.text,\n        color: this.color,\n        font: this.font,\n        v: 1\n      });\n      this.dragAction = 'place';\n      this.currentShapeState = 'selected';\n    }\n    if (this.dragAction === 'none') {\n      this.commit(lc);\n      return;\n    }\n    this.initialShapeBoundingRect = this.currentShape.getBoundingRect(lc.ctx);\n    this.dragOffset = {\n      x: x - this.initialShapeBoundingRect.x,\n      y: y - this.initialShapeBoundingRect.y\n    };\n    this._setShapesInProgress(lc);\n    return lc.repaintLayer('main');\n  };\n\n  Text.prototype[\"continue\"] = function(x, y, lc) {\n    var br, brBottom, brRight;\n    if (this.dragAction === 'none') {\n      return;\n    }\n    br = this.initialShapeBoundingRect;\n    brRight = br.x + br.width;\n    brBottom = br.y + br.height;\n    switch (this.dragAction) {\n      case 'place':\n        this.currentShape.x = x;\n        this.currentShape.y = y;\n        this.didDrag = true;\n        break;\n      case 'move':\n        this.currentShape.x = x - this.dragOffset.x;\n        this.currentShape.y = y - this.dragOffset.y;\n        this.didDrag = true;\n        break;\n      case 'resizeBottomRight':\n        this.currentShape.setSize(x - (this.dragOffset.x - this.initialShapeBoundingRect.width) - br.x, y - (this.dragOffset.y - this.initialShapeBoundingRect.height) - br.y);\n        break;\n      case 'resizeTopLeft':\n        this.currentShape.setSize(brRight - x + this.dragOffset.x, brBottom - y + this.dragOffset.y);\n        this.currentShape.setPosition(x - this.dragOffset.x, y - this.dragOffset.y);\n        break;\n      case 'resizeBottomLeft':\n        this.currentShape.setSize(brRight - x + this.dragOffset.x, y - (this.dragOffset.y - this.initialShapeBoundingRect.height) - br.y);\n        this.currentShape.setPosition(x - this.dragOffset.x, this.currentShape.y);\n        break;\n      case 'resizeTopRight':\n        this.currentShape.setSize(x - (this.dragOffset.x - this.initialShapeBoundingRect.width) - br.x, brBottom - y + this.dragOffset.y);\n        this.currentShape.setPosition(this.currentShape.x, y - this.dragOffset.y);\n    }\n    this._setShapesInProgress(lc);\n    lc.repaintLayer('main');\n    return this._updateInputEl(lc);\n  };\n\n  Text.prototype.end = function(x, y, lc) {\n    if (!this.currentShape) {\n      return;\n    }\n    this.currentShape.setSize(this.currentShape.forcedWidth, 0);\n    if (this.currentShapeState === 'selected') {\n      if (this.dragAction === 'place' || (this.dragAction === 'move' && !this.didDrag)) {\n        this._enterEditingState(lc);\n      }\n    }\n    this._setShapesInProgress(lc);\n    lc.repaintLayer('main');\n    return this._updateInputEl(lc);\n  };\n\n  Text.prototype._enterEditingState = function(lc) {\n    var onChange;\n    this.currentShapeState = 'editing';\n    if (this.inputEl) {\n      throw \"State error\";\n    }\n    this.inputEl = document.createElement('textarea');\n    this.inputEl.className = 'text-tool-input';\n    this.inputEl.style.position = 'absolute';\n    this.inputEl.style.transformOrigin = '0px 0px';\n    this.inputEl.style.backgroundColor = 'transparent';\n    this.inputEl.style.border = 'none';\n    this.inputEl.style.outline = 'none';\n    this.inputEl.style.margin = '0';\n    this.inputEl.style.padding = '4px';\n    this.inputEl.style.zIndex = '1000';\n    this.inputEl.style.overflow = 'hidden';\n    this.inputEl.style.resize = 'none';\n    this.inputEl.value = this.currentShape.text;\n    this.inputEl.addEventListener('mousedown', function(e) {\n      return e.stopPropagation();\n    });\n    this.inputEl.addEventListener('touchstart', function(e) {\n      return e.stopPropagation();\n    });\n    onChange = (function(_this) {\n      return function(e) {\n        _this.currentShape.setText(e.target.value);\n        _this.currentShape.enforceMaxBoundingRect(lc);\n        _this._setShapesInProgress(lc);\n        lc.repaintLayer('main');\n        _this._updateInputEl(lc);\n        return e.stopPropagation();\n      };\n    })(this);\n    this.inputEl.addEventListener('keydown', (function(_this) {\n      return function() {\n        return _this._updateInputEl(lc, true);\n      };\n    })(this));\n    this.inputEl.addEventListener('keyup', onChange);\n    this.inputEl.addEventListener('change', onChange);\n    this._updateInputEl(lc);\n    lc.containerEl.appendChild(this.inputEl);\n    this.inputEl.focus();\n    return this._setShapesInProgress(lc);\n  };\n\n  Text.prototype._exitEditingState = function(lc) {\n    this.currentShapeState = 'selected';\n    lc.containerEl.removeChild(this.inputEl);\n    this.inputEl = null;\n    this._setShapesInProgress(lc);\n    return lc.repaintLayer('main');\n  };\n\n  Text.prototype._updateInputEl = function(lc, withMargin) {\n    var br, transformString;\n    if (withMargin == null) {\n      withMargin = false;\n    }\n    if (!this.inputEl) {\n      return;\n    }\n    br = this.currentShape.getBoundingRect(lc.ctx, true);\n    this.inputEl.style.font = this.currentShape.font;\n    this.inputEl.style.color = this.currentShape.color;\n    this.inputEl.style.left = (lc.position.x / lc.backingScale + br.x * lc.scale - 4) + \"px\";\n    this.inputEl.style.top = (lc.position.y / lc.backingScale + br.y * lc.scale - 4) + \"px\";\n    if (withMargin && !this.currentShape.forcedWidth) {\n      this.inputEl.style.width = (br.width + 10 + this.currentShape.renderer.emDashWidth) + \"px\";\n    } else {\n      this.inputEl.style.width = (br.width + 12) + \"px\";\n    }\n    if (withMargin) {\n      this.inputEl.style.height = (br.height + 10 + this.currentShape.renderer.metrics.leading) + \"px\";\n    } else {\n      this.inputEl.style.height = (br.height + 10) + \"px\";\n    }\n    transformString = \"scale(\" + lc.scale + \")\";\n    this.inputEl.style.transform = transformString;\n    this.inputEl.style.webkitTransform = transformString;\n    this.inputEl.style.MozTransform = transformString;\n    this.inputEl.style.msTransform = transformString;\n    return this.inputEl.style.OTransform = transformString;\n  };\n\n  Text.prototype.optionsStyle = 'font';\n\n  return Text;\n\n})(Tool);\n"]},"metadata":{},"sourceType":"script"}